#!/usr/bin/env ruby
#
# Compatible using wicd-gtk version >= 1.7

require 'fileutils'
require 'pathname'
require 'pp'

class Installer
  attr_reader :rootdir
  attr_reader :srcdir

  class << self
    def install(style = :light)
      self.new(style || :light).prepare.install.clean
    end
  end

  def initialize(style = :light)
    @rootdir = Pathname.new('/usr/share/wicd/icons/hicolor')
    @srcdir  = Pathname.new(__dir__).join(style.to_s, 'wicd')

    unless @srcdir.directory?
      raise ArgumentError.new('Invalid style: %s' % style)
    end
  end

  def install
    ['16x16', '22x22'].each do |size|
      get_status_paths(size).each do |k, v|
        next unless k.file?
        FileUtils.cp(v, k, verbose: true)
      end
    end
    self
  end

  def prepare
    preparable_icons.each do |k, values|
      values.each do |v|
        FileUtils.ln_sf(@srcdir.join('%s.png' % k), @srcdir.join('%s.png' % v), verbose: true)
      end
    end
    self
  end

  def clean
    preparable_icons.each do |k, values|
      values.each do |v|
        FileUtils.remove(@srcdir.join('%s.png' % v))
      end
    end
    self
  end

  protected

  def get_status_paths(size = '16x16', format = 'png')
    result = {}
    {
      # 16x16
      'signal-25'  => 'low-signal',
      'signal-50'  => 'bad-signal',
      'signal-75'  => 'both-good-signal',
      'signal-100' => 'both-high-signal',
      # 22x22
      'bad-signal' => false,
      'bad-signal-lock' => false,
      'both-bad-signal' => false,
      'both-bad-signal-lock' => false,
      'both-good-signal' => false,
      'both-good-signal-lock' => false,
      'both-high-signal' => false,
      'both-high-signal-lock' => false,
      'both-low-signal' => false,
      'both-low-signal-lock' => false,
      'good-signal' => false,
      'good-signal-lock' => false,
      'high-signal' => false,
      'high-signal-lock' => false,
      'idle-bad-signal' => false,
      'idle-bad-signal-lock' => false,
      'idle-good-signal' => false,
      'idle-good-signal-lock' => false,
      'idle-high-signal' => false,
      'idle-high-signal-lock' => false,
      'idle-low-signal' => false,
      'idle-low-signal-lock' => false,
      'low-signal' => false,
      'low-signal-lock' => false,
      'no-signal' => false,
      'receiving-bad-signal' => false,
      'receiving-bad-signal-lock' => false,
      'receiving-good-signal' => false,
      'receiving-good-signal-lock' => false,
      'receiving-high-signal' => false,
      'receiving-high-signal-lock' => false,
      'receiving-low-signal' => false,
      'receiving-low-signal-lock' => false,
      'transmitting-bad-signal' => false,
      'transmitting-bad-signal-lock' => false,
      'transmitting-good-signal' => false,
      'transmitting-good-signal-lock' => false,
      'transmitting-high-signal' => false,
      'transmitting-high-signal-lock' => false,
      'transmitting-low-signal' => false,
      'transmitting-low-signal-lock' => false,
    }.each do |k, v|
      paths = [
        @rootdir.join(size, 'status', '%s.%s' % [k, format]),
        @srcdir.join('%s.%s' % [v == false ? k : v, format])
      ]

      result[paths[0]] = paths[1]
    end
    result
  end

  def preparable_icons
    {'low-signal' => [
       'both-low-signal-lock',
       'both-low-signal',
       'idle-low-signal-lock',
       'idle-low-signal',
       'low-signal-lock',
       'receiving-low-signal-lock',
       'receiving-low-signal',
       'transmitting-low-signal-lock',
       'transmitting-low-signal',
     ],
     'bad-signal' => [
       'bad-signal-lock',
       'both-bad-signal-lock',
       'both-bad-signal',
       'idle-bad-signal-lock',
       'idle-bad-signal',
       'receiving-bad-signal-lock',
       'receiving-bad-signal',
       'transmitting-bad-signal-lock',
       'transmitting-bad-signal',
     ],
     'good-signal' => [
       'both-good-signal-lock',
       'both-good-signal',
       'good-signal-lock',
       'idle-good-signal-lock',
       'idle-good-signal',
       'receiving-good-signal-lock',
       'receiving-good-signal',
       'transmitting-good-signal-lock',
       'transmitting-good-signal',
     ],
     'high-signal' => [
       'both-high-signal-lock',
       'both-high-signal',
       'high-signal-lock',
       'idle-high-signal-lock',
       'idle-high-signal',
       'receiving-high-signal-lock',
       'receiving-high-signal',
       'transmitting-high-signal-lock',
       'transmitting-high-signal',
     ]
    }
  end
end

Installer.install(ARGV[0]) if __FILE__ == $0
